{% extends "quotes/base.html" %}
{% load quote_extras %}

{% block title %}–¶–∏—Ç–∞—Ç—ã –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è{% endblock %}

{% block content %}
<div class="card p-4 shadow">

    <div class="mb-3">
        <strong>–§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞:</strong>
        <a href="{% url 'random_source_quotes' %}" class="btn btn-outline-secondary btn-sm {% if not type_filter %}active{% endif %}">–í—Å–µ</a>
        <a href="{% url 'random_source_quotes' %}?type=film" class="btn btn-outline-secondary btn-sm {% if type_filter == 'film' %}active{% endif %}">–§–∏–ª—å–º—ã</a>
        <a href="{% url 'random_source_quotes' %}?type=book" class="btn btn-outline-secondary btn-sm {% if type_filter == 'book' %}active{% endif %}">–ö–Ω–∏–≥–∏</a>
        <a href="{% url 'random_source_quotes' %}?type=game" class="btn btn-outline-secondary btn-sm {% if type_filter == 'game' %}active{% endif %}">–ò–≥—Ä—ã</a>
    </div>

    {% if quotes %}
        <h2>–¶–∏—Ç–∞—Ç—ã –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è: {{ source }}</h2>
        <div class="list-group">
            {% for quote in quotes %}
                <div class="list-group-item mb-2">
                    <p>{{ quote.text|linebreaksbr }}</p>
                    <p class="text-muted"><em>{{ quote.source }}</em></p>
                    <p>
                        Views: {{ quote.views }} |
                        Likes: <span id="likes-{{ quote.id }}">{{ quote.likes }}</span> |
                        Dislikes: <span id="dislikes-{{ quote.id }}">{{ quote.dislikes }}</span>
                    </p>

                    {% if user.is_authenticated %}
                        {% with user_vote=quote.votes|get_vote:user %}
                        <div class="mb-2">
                            <button id="like-btn-{{ quote.id }}" class="btn me-2 {% if user_vote == 'like' %}btn-success{% else %}btn-primary{% endif %}">üëç –õ–∞–π–∫</button>
                            <button id="dislike-btn-{{ quote.id }}" class="btn {% if user_vote == 'dislike' %}btn-danger{% else %}btn-primary{% endif %}">üëé –î–∏–∑–ª–∞–π–∫</button>
                        </div>
                        {% endwith %}
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p>–¶–∏—Ç–∞—Ç –ø–æ–∫–∞ –Ω–µ—Ç –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è.</p>
    {% endif %}

    <p class="mt-3">
        <a href="{% url 'random_quote' %}" class="btn btn-outline-primary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ª—É—á–∞–π–Ω–æ–π —Ü–∏—Ç–∞—Ç–µ</a>
    </p>
</div>

{% if user.is_authenticated %}
<script>
function sendVote(quoteId, voteType) {
    fetch(`/vote/${quoteId}/${voteType}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (!data.error) {
            document.getElementById(`likes-${quoteId}`).textContent = data.likes;
            document.getElementById(`dislikes-${quoteId}`).textContent = data.dislikes;

            const likeBtn = document.getElementById(`like-btn-${quoteId}`);
            const dislikeBtn = document.getElementById(`dislike-btn-${quoteId}`);

            if (voteType === 'like') {
                likeBtn.classList.add('btn-success');
                likeBtn.classList.remove('btn-primary');
                dislikeBtn.classList.remove('btn-danger');
                dislikeBtn.classList.add('btn-primary');
            } else {
                dislikeBtn.classList.add('btn-danger');
                dislikeBtn.classList.remove('btn-primary');
                likeBtn.classList.remove('btn-success');
                likeBtn.classList.add('btn-primary');
            }
        } else {
            alert(data.error);
        }
    });
}

{% for quote in quotes %}
document.getElementById("like-btn-{{ quote.id }}")?.addEventListener("click", () => sendVote({{ quote.id }}, 'like'));
document.getElementById("dislike-btn-{{ quote.id }}")?.addEventListener("click", () => sendVote({{ quote.id }}, 'dislike'));
{% endfor %}
</script>
{% endif %}
{% endblock %}
