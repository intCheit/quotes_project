{% extends "quotes/base.html" %}
{% block title %}–°–ª—É—á–∞–π–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞{% endblock %}

{% block content %}
<div class="card p-4 shadow">
    {% if quote %}
        <h3 class="card-title">{{ quote.text|linebreaksbr }}</h3>
        <p class="text-muted"><em>{{ quote.source }}</em></p>

        {% if quote.movie_link %}
            <p>üé¨ <a href="{{ quote.movie_link }}" target="_blank">–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∏–ª—å–º</a></p>
        {% endif %}

        <p>üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä—ã: {{ quote.views }} | üëç –õ–∞–π–∫–∏: <span id="likes">{{ quote.likes }}</span> | üëé –î–∏–∑–ª–∞–π–∫–∏: <span id="dislikes">{{ quote.dislikes }}</span></p>

        {% if user.is_authenticated and quote.author == user %}
            <a href="{% url 'edit_quote' quote.id %}" class="btn btn-outline-primary btn-sm me-2 mb-2">
                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </a>
        {% endif %}

        {% if user.is_authenticated %}
        <div class="mb-3 d-flex align-items-center">
            <button id="like-btn" class="btn me-2 {% if user_vote == 'like' %}btn-success{% else %}btn-primary{% endif %}">üëç –õ–∞–π–∫</button>
            <button id="dislike-btn" class="btn {% if user_vote == 'dislike' %}btn-danger{% else %}btn-primary{% endif %}">üëé –î–∏–∑–ª–∞–π–∫</button>
        </div>

        <script>
        function sendVote(voteType) {
            fetch(`/vote/{{ quote.id }}/${voteType}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    document.getElementById('likes').textContent = data.likes;
                    document.getElementById('dislikes').textContent = data.dislikes;

                    const likeBtn = document.getElementById('like-btn');
                    const dislikeBtn = document.getElementById('dislike-btn');

                    if (voteType === 'like') {
                        likeBtn.classList.add('btn-success');
                        likeBtn.classList.remove('btn-primary');
                        dislikeBtn.classList.remove('btn-danger');
                        dislikeBtn.classList.add('btn-primary');
                    } else {
                        dislikeBtn.classList.add('btn-danger');
                        dislikeBtn.classList.remove('btn-primary');
                        likeBtn.classList.remove('btn-success');
                        likeBtn.classList.add('btn-primary');
                    }
                } else {
                    alert(data.error);
                }
            });
        }

        document.getElementById('like-btn').addEventListener('click', () => sendVote('like'));
        document.getElementById('dislike-btn').addEventListener('click', () => sendVote('dislike'));
        </script>
        {% else %}
            <p>–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å: <a href="{% url 'login' %}">–í—Ö–æ–¥</a></p>
        {% endif %}

        <div class="d-flex flex-wrap mb-3">
            <a href="{% url 'top_quotes' %}" class="btn btn-outline-primary me-2 mb-2">
                üèÜ –¢–æ–ø-10 —Ü–∏—Ç–∞—Ç
            </a>
            <a href="{% url 'random_source_quotes' %}" class="btn btn-outline-secondary me-2 mb-2">
                üé≤ –¶–∏—Ç–∞—Ç—ã —Å–ª—É—á–∞–π–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
            </a>
            <a href="{% url 'dashboard' %}" class="btn btn-outline-success me-2 mb-2">
                üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü–∏—Ç–∞—Ç
            </a>
        </div>
    {% else %}
        <p>–¶–∏—Ç–∞—Ç –ø–æ–∫–∞ –Ω–µ—Ç!</p>
        <a href="{% url 'add_quote' %}" class="btn btn-outline-primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é —Ü–∏—Ç–∞—Ç—É</a>
    {% endif %}
</div>
{% endblock %}
